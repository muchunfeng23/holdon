<style type="text/css">
	#modify_transfer_modal .modal_title {
        padding: 15px;
        margin: 0;
        border-bottom: 1px solid #e5e5e5;
    }
    #modify_transfer_modal .modal_body {
        padding: 15px;
        min-height: 150px;
    }
    #modify_transfer_modal .modal_footer {
        border-top: 1px solid #e5e5e5;
        padding: 15px;
        text-align: right;
    }
</style>
<div class="modal fade" id="modal-profit-info1" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog" id="modal-dialog1" style="width: 1000px;">
		<div class="modal-content">
			<div class="modal-header">
				<!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> -->
				<h4 id="modalTitle" class="modal-title">匹配竞品页</h4>
			</div>
			<div class="modal-body">
				<section class="search-body">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title">基本信息</h3>
						</div>
						<!-- 商品信息表 -->
						<table id="tableIndex1" data-toolbar="#toolbar"></table>
					</div>
				</section>
				<section class="search-body">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title">匹配竞对商品</h3>
						</div>
						<!-- 竞对商品信息表 -->
						<table id="tableIndex2" data-toolbar="#toolbar"></table>
					</div>
				</section>
				<section class="search-body">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title">竞对商品搜索</h3>
						</div>
						<ul id="myTab" class="nav nav-tabs">
							<li id="search" class="active"><a href="#home" data-toggle="tab">
								搜索匹配</a></li>
							<li id="machine"><a href="#auto" data-toggle="tab">机器匹配</a></li>
						</ul>
						<div id="myTabContent" class="tab-content">

							<div class="tab-pane fade in active panel-body" id="home">
								<form role="form" id="search_form" class="form">
									<div class="form-group mc-form-group">
										<input id="hideSku" class="form-control" type="hidden"/>
										<input id="hideSsu" class="form-control" type="hidden"/>
										<input id="hideCity" class="form-control" type="hidden"/>
										
										<label class="control-label">名称:</label>
										<input id="name1" type="text" class="form-control" />
									</div>
									<div class="form-group mc-form-group">
										<label class="control-label">平台:</label>
										<select id="select-sourse1" name="select-sourse" class="form-control">
											<option selected="selected" value="kuailv">快驴</option>
										</select>
									</div>
									<div class="form-group mc-form-group">
										<button id="searchIndex1" type="button" class="btn btn-sch btn-primary">查询</button>
									</div>
								</form>
								<section>
									<table id="tableIndex3" data-toolbar="#toolbar"></table>
								</section>
							</div>
							<div class="tab-pane fade" id="auto">
								<section>
									<table id="tableIndex4" data-toolbar="#toolbar"></table>
								</section>
							</div>
						</div>
					</div>
				</section>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default modal-btn-close" data-dismiss="modal" aria-label="Close">关闭</button>
			</div>
		</div>
	</div>
	
	
	<div class="modal-dialog" id="modal-dialog2" style="width: 475px;display:none;">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 id="modalTitle2" class="modal-title">计价单位转换</h4>
			</div>
			<div class="modal-body">
				<section class="search-body">
						<form class="form-horizontal" onsubmit="return false;">
						  <input id="transferPricePostValue" style="display:none;"/>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">竞品ID</label>
						    <div class="col-sm-8">
						    	<label id="jingpinId" class="control-label"></label>
						    </div>
						  </div>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">竞品名称</label>
						    <div class="col-sm-8">
						    	<label id="jingpinName" class="control-label"></label>
						    </div>
						  </div>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">平台</label>
						    <div class="col-sm-8">
						    	<label id="jingpinPlatform" class="control-label"></label>
						    </div>
						  </div>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">来源网页</label>
						    <div class="col-sm-8">
						    	<label class="control-label"><a class="profit-info-view" id="jingpinUrl" href="${row.pictureUrl}" target="_blank">来源网页</a></label>
						    </div>
						  </div>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">竞品价</label>
						    <div class="col-sm-8">
						    	<label id="jingpinPrice" class="control-label"></label>
						    </div>
						  </div>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">规格</label>
						    <div class="col-sm-8">
						    	<label id="jingpinFormat" class="control-label"></label>
						    </div>
						  </div>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">转换倍数</label>
						    <div class="col-sm-8">
						      <input type="text" class="form-control" id="conversionFactor" placeholder="输入一个不为0的数">
						    </div>
						  </div>
						  <div class="form-group" style="margin-bottom:2px;">
						    <label class="col-sm-4 control-label">转换竞品价</label>
						    <div class="col-sm-8">
						      <input type="text" class="form-control" id="transferPrice" readonly="readonly">
						    </div>
						  </div>
						  <div class="form-group" style="margin-top:10px;">
						    <div class="col-sm-offset-8 col-sm-4">
						      <button type="submit" id="transferPriceSubmit" class="btn btn-primary">提交</button>
						    </div>
						  </div>
						</form>
				</section>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default modal-btn-close" data-dismiss="modal" aria-label="Close">关闭</button>
			</div>
		</div>
	</div>
	
</div>
<div id="layui-container" style="display: none;">
     <input value="打发"  type="text" placeholder="请输入昵称" maxlength="8">
 </div>
<script type="text/javascript">

	var tableIndex1 = $("#tableIndex1");
	var tableIndex2 = $("#tableIndex2");
	var tableIndex3 = $("#tableIndex3");
	var tableIndex4 = $("#tableIndex4");
	var searchIndex1 = $("#searchIndex1");
	var arrColumns1 = [{
		field: 'skuId',
	    title: 'SKU-ID',
	    align: 'center'
	},{
		field: 'ssuId',
	    title: 'SSU-ID',
	    align: 'center'
	},{
		field: 'ssuName',
	    title: '商品名称',
	    align: 'center'
	},{
	    title: '自营零售价',
	    align: 'center',
	    formatter: function(v,row){
            return `<lable style="color:#00CD00;font-weight:bold">${row.price}</lable>`
        }
	},{
		field: 'ssuBrand',
	    title: '品牌',
	    align: 'center'
	},{
		field: 'ssuFormat',
	    title: '规格',
	    align: 'center'
	},{
		field: 'ssuUnit',
	    title: '计价单位',
	    align: 'center'
	}];
	
	var arrColumns2 = [{
		field: 'id',
	    title: '爬虫商品ID',
	    align: 'center'
	},{
		field: 'name',
	    title: '商品名称',
	    align: 'center'
	},{
		field: 'description',
	    title: '商品描述',
	    align: 'center'
	},{
	    title: '价格',
	    align: 'center',
	    formatter: function(v,row){
            return `<lable style="color:#FF0000;font-weight:bold">${row.price}</lable> ${row.dt}`
        }
	},{
		field: 'unit',
	    title: '单位',
	    align: 'center'
	},{
		field: 'format',
	    title: '规格',
	    align: 'center'
	},{
		field: 'sourceCH',
	    title: '来源平台',
	    align: 'center'
	},{
		field: 'bandCtStr',
	    title: '绑定时间',
	    align: 'center'
	},{
	    title: '网页',
	    align: 'center',
	    formatter: function(v,row){
            if(row.pictureUrl==''){
    			return `来源网页`
    		}
            return `<a class="profit-info-view" href="${row.pictureUrl}" target="_blank">来源网页</a>`
        }
	},{
		title: '操作',
	    align: 'center',
	    formatter: function(v,row){
	    	return `<a class="is_band" href="javascript:void(0)" onclick="band(${row.id},${row.ssuId},${row.matchId},${row.isBand},${row.type})" target="_blank">${row.isBandStr}</a>`;
        }
	},{
		title: '修改计价单位',
	    align: 'center',
	    formatter: function(v,row){
	    	return `<a class="is_band" href="javascript:void(0)" onclick="modify(${row.id},'${row.name}','${row.format}',${row.price},'${row.sourceCH}','${row.pictureUrl}')" target="_blank">修改</a>`;
        }
	}];
	
	var arrColumns3 = [{
		field: 'id',
	    title: '爬虫商品ID',
	    align: 'center'
	},{
		field: 'name',
	    title: '商品名称',
	    align: 'center'
	},{
		field: 'description',
	    title: '商品描述',
	    align: 'center'
	},{
		field: 'format',
	    title: '规格',
	    align: 'center'
	},{
	    title: '价格',
	    align: 'center',
	    formatter: function(v,row){
            return `<lable style="color:#FF0000;font-weight:bold">${row.price}</lable> ${row.dt}`
        }
	},{
		field: 'unit',
	    title: '单位',
	    align: 'center'
	},{
		field: 'sourceCH',
	    title: '来源平台',
	    align: 'center'
	},{
		field: 'score',
	    title: '机器匹配分数',
	    align: 'center'
	},{
	    title: '网页',
	    align: 'center',
	    formatter: function(v,row){
	    	if(row.pictureUrl==''){
    			return `来源网页`
    		}
            return `<a class="profit-info-view" href="${row.pictureUrl}" target="_blank">来源网页</a>`
        }
	},{
	    title: '操作',
	    align: 'center',
	    formatter: function(v,row){
	    	if(row.isBand==null || row.isBand==0 || row.isBand==2){
	    		return `<a class="profit-info-view" onclick="band(${row.id},${row.ssuId},${row.matchId},${row.isBand},${row.type})" target="_blank" style="cursor:pointer">绑定</a>`
	    	}else if(row.ssuId == $("#hideSsu").val()){
	    		return `已绑定`
	    	}else {
	    		return `<a class="profit-info-view" onclick="band(${row.id},${row.ssuId},${row.matchId},${row.isBand},${row.type})" target="_blank" style="cursor:pointer">绑定</a>`
	    	}
        }
	}];
	
	searchIndex1.on('click',function(){initPageSearch1()});
	
	function initPageSearch1(obj){
		var source = $("#select-sourse1").val();
		var name = $("#name1").val();
		if(source == "" && name == ""){
			layer.msg('请输入查询条件');
            return;
		}
        tableIndex3.bootstrapTable('destroy').bootstrapTable({
            columns:arrColumns3,
            uniqueId:'id',
            url:'/research/crawlermatch/getSearchMatching',
            queryParamsType:'',
            pagination:true,
            sidePagination: 'server',
            method:'post',
            pageSize:5,
            pageList: [5,10,15,20],
            paginationPreText: "上一页",
            paginationNextText: "下一页",
            paginationFirstText: "首页",
            paginationLastText: "尾页",
            queryParams:function (params) {
                params.source = $("#select-sourse1").val();
                params.name = $("#name1").val();
                params.cityId = $("#hideCity").val();
                params.ssuId = $("#hideSsu").val();
                return params;
            },
            responseHandler:function(res){
                if(res.data){
                    return res.data
                }else{
                    return [];
                }
            }
        });
    }
	
	function band(id,ssuId,matchId,isBand,type){
		var skuId=$("#hideSku").val();
		ssuId=$("#hideSsu").val();
		var info="";
		if(isBand==null || isBand==0 || isBand==2)
			info="确定要绑定?";
		else
			info="确定要解除绑定?";
		layer.confirm(info, {icon: 3, title:'确定'}, function(index){
		  	
	        $.ajax({
	            method:'post',
	            url:'/research/crawlermatch/updateBand',
	            data:JSON.stringify({id:id,ssuId:ssuId,skuId:skuId,matchId:matchId,isBand:isBand,type:type}),
	            dataType:'json',
	            contentType:'application/json',
	            success:function(json){
	                if(json.error_code==0){
	                    rowIndex = $(this).parent().parent().attr('data-uniqueid');
	                    $('[name=refresh]').click();
	                    tableIndex4.bootstrapTable('refresh');
	                    tableIndex3.bootstrapTable('refresh');
	                    tableIndex2.bootstrapTable('refresh');
	                }else{
	                    layer.msg('操作失败');
	                }
	            }
	        });
		  layer.close(index);
		});
	}
	
	function modify(id,name,format,price,sourceCH,pictureUrl){
		$("#modal-dialog1").hide();
		$("#jingpinId").html(id);
		$("#jingpinName").html(name);
		$("#jingpinPlatform").html(sourceCH);
		$("#jingpinUrl").attr("href",pictureUrl)
		$("#jingpinPrice").html(price);
		$("#jingpinFormat").html(format);
		$("#modal-dialog2").show();
		$("#conversionFactor").val("");
		$("#transferPrice").val("");
		$("#transferPricePostValue").val(JSON.stringify({id:id,name:name,format:format,price:price,sourceCH:sourceCH,pictureUrl:pictureUrl}));
	}
	
	$(function(){
		$("#transferPriceSubmit").click(function(){
			var competeCommodityId = $("#jingpinId").html();
			var conversionFactor = $("#conversionFactor").val();
			if(isNaN(competeCommodityId) || isNaN(conversionFactor)){
				layer.msg("输入内容只能是数字");
				return;
			}
			conversionFactor = conversionFactor * 1000;
			$.ajax({
	            method:'post',
	            url:'/research/crawlermatch/updateConversionFactor',
	            data:JSON.stringify({id:parseInt(competeCommodityId),conversionFactor:parseInt(conversionFactor)}),
	            dataType:'json',
	            contentType:'application/json',
	            success:function(json){
	                if(json.error_code==0){
	                    $("#modal-dialog1").show();
	        			$("#modal-dialog2").hide();
	        			//更新table中某行某列
	        			$('[name=refresh]').click();
	                }else{
	                	layer.msg(json.data);
	                }
	            }
	        });
		});
		$("#conversionFactor").keyup(function(){
			if(isNaN($(this).val())){
				layer.msg("请输入数字");
				return;
			}
			var inputValue = $(this).val();
			var jingpinPrice = parseFloat($("#jingpinPrice").html());
			var transferPrice = Math.floor(inputValue * jingpinPrice*100) / 100;
			$("#transferPrice").val(transferPrice);
		});
	});

</script>

</html>
